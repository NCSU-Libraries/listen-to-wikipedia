var pusher = new Pusher('bef9976092c8ba1e7452', {authEndpoint: '<%= L2wControl::Application.routes.url_helpers.pusher_authenticate_url %>'});
var channel = pusher.subscribe('presence-listen_to_wikipedia');
var SOCKETS = {};

function show_wikimon_changes(data){
  for (var key in data) {
      if (data[key] == true){
        if (!SOCKETS[key]) {
          SOCKETS[key] = new wikipediaSocket.init(wikimon_langs[key][1], key);
          SOCKETS[key].connect();
        }
      } else {
        if (SOCKETS[key] && SOCKETS[key].connection) {
          SOCKETS[key].close();
        }
      }
    }
}


channel.bind('update', function(data) {
  if ($('#wikimon_changes').length > 0) {
    show_wikimon_changes(data.message);
  } else {
    location.reload();
  }
});

channel.bind('pusher:subscription_succeeded', function(members){
  members.each(check_members);
  // console.log("Count", members.count)
})

channel.bind('pusher:member_removed', function(member){
  if (member.id.indexOf("wall_") == 0 ) {
    $('#offline').show();
    $('#online').hide();
  }
  // console.log("Count", channel.members.count)
})

channel.bind('pusher:member_added', function(member){
  if (member.id.indexOf("wall_") == 0 ) {
    $('#offline').hide();
    $('#online').show();
  }
  // console.log("Count", channel.members.count)
})

function check_members(member){
  if (member.id.indexOf("wall_") == 0 ) {
    $('#offline').hide();
    $('#online').show();
  }
}